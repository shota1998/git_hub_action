name: send_file

on:
  push:
    branches: [ "exec_command" ]

env:
  PATH_TO_ARTIFACT: path/to/artifact/artifact
  TAR_FILE_NAME: artifact.tar

jobs:
  create_artifact:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create artifact
      run: |
        mkdir -p ${{ env.PATH_TO_ARTIFACT }}
        echo hello2 > ${{ env.PATH_TO_ARTIFACT }}/world.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: my-artifact
        path: ${{ env.PATH_TO_ARTIFACT }}/world.txt

  send_artifact:
    
    needs: create_artifact
    runs-on: ubuntu-latest

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      id: test
      with:
        name: my-artifact
        path: ${{ env.PATH_TO_ARTIFACT }}

    - name: Show artifact
      run: |
        echo "File path: "
        echo ${{ steps.test.outputs.download-path }}
        echo "ls file path: "
        ls -la  ${{ steps.test.outputs.download-path }}
        echo "File content : " 
        cat ${{ steps.test.outputs.download-path }}/world.txt

    - name: Compress artifact
      run: tar -cvf ${{ env.TAR_FILE_NAME }} ${{ steps.test.outputs.download-path }}

    - name: Generate private key
      run: | 
        echo "${{ secrets.KEY }}" > ${{ runner.temp }}/key
        chmod 700 ${{ runner.temp }}/key

    - name: Send artifact
      run: |
        scp -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -i ${{ runner.temp }}/key \
            -P 22 \
            ${{ env.TAR_FILE_NAME }} \
            ${{ secrets.DEST_USER }}@${{ secrets.DEST_IP }}:${{ secrets.DEST_DIR }}

  run_app:

    needs: send_artifact
    runs-on: ubuntu-latest

    steps:
    - name: Generate private key
      run: | 
        echo "${{ secrets.KEY }}" > ${{ runner.temp }}/key
        chmod 700 ${{ runner.temp }}/key

    - name: Decompress artifact
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=5
            -i ${{ runner.temp }}/key \
            -l ${{ secrets.DEST_USER }} \
            -R ${{ secrets.DEST_IP }} \
            -P 22 \
            

    - name: Run app
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=5
            -i ${{ runner.temp }}/key \
            -l ${{ secrets.DEST_USER }} \
            -R ${{ secrets.DEST_IP }} \
            -P 22 \
            'cat world.txt'