name: send_file

on:
  push:
    branches: [ "run_app" ]

env:
  PATH_TO_ARTIFACT: path/to/artifact/artifact
  TAR_FILE_NAME: artifact.tar
  FILE_NAME: world.txt

jobs:
  create_artifact:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create artifact
      run: |
        mkdir -p ${{ env.PATH_TO_ARTIFACT }}
        echo hello2 > ${{ env.PATH_TO_ARTIFACT }}/${{ env.FILE_NAME}}

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: my-artifact
        path: ${{ env.PATH_TO_ARTIFACT }}/${{ env.FILE_NAME}}

  send_artifact:
    
    needs: create_artifact
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Download artifact
      uses: actions/download-artifact@v3
      id: test
      with:
        name: my-artifact
        path: ${{ env.PATH_TO_ARTIFACT }}

    - name: Show artifact
      run: |
        echo "File path: "
        echo ${{ steps.test.outputs.download-path }}
        echo "ls file path: "
        ls -la  ${{ steps.test.outputs.download-path }}
        echo "File content : " 
        cat ${{ steps.test.outputs.download-path }}/${{ env.FILE_NAME}}

    - name: Compress artifact
      run: |
        mv docker-compose.yml ${{ steps.test.outputs.download-path }}
        cd ${{ steps.test.outputs.download-path }}
        tar -cvf ~/${{ env.TAR_FILE_NAME }} .

    - name: Generate ssh private key
      uses: shimataro/ssh-key-action@v2
      with: 
        key: ${{ secrets.KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
        if_key_exists : replace

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3

    - name: Send artifact
      run: |
        scp -o StrictHostKeyChecking=no \
            -P 22                       \
            ~/${{ env.TAR_FILE_NAME }}  \
            ${{ secrets.DEST_USER }}@${{ secrets.DEST_IP }}:${{ secrets.DEST_DIR }}

  run_app:

    needs: send_artifact
    runs-on: ubuntu-latest

    steps:
    - name: Generate ssh private key
      uses: shimataro/ssh-key-action@v2
      with: 
        key: ${{ secrets.KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
        if_key_exists : replace
          
    - run: ls -la ~/.ssh

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      
    - name: Decompress artifact
      run: |
        ssh                                                  \
          -t ${{ secrets.DEST_USER }}@${{ secrets.DEST_IP }} \
          -p 22                                              \
          -o StrictHostKeyChecking=no                        \
          -o ConnectTimeout=5                                \
          "
            tar -xvf ${{ env.TAR_FILE_NAME }} && \
            ls -la                            && \
            docker-compose -f docker-compose.yml up 
          "